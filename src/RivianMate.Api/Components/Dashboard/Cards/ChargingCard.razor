@using RivianMate.Api.Components.Shared
@using RivianMate.Api.Helpers
@using RivianMate.Api.Services
@using RivianMate.Core.Entities
@using RivianMate.Core.Enums

<CardWrapper Definition="@GetDefinition()">
    @if (RecentSessions?.Any() == true)
    {
        <div class="charging-sessions-list">
            @foreach (var session in RecentSessions.Take(4))
            {
                <a href="@GetSessionUrl(session.Id)" class="charging-session-item clickable">
                    <div class="charging-list-icon @ChargeTypeHelper.GetCssClass(session.ChargeType)">
                        <Icon Name="@ChargeTypeHelper.GetIcon(session.ChargeType)" Size="14" />
                    </div>
                    <div class="session-details">
                        <div class="session-header">
                            <span class="session-location">@(session.LocationName ?? ChargeTypeHelper.GetDisplayName(session.ChargeType))</span>
                            <span class="session-time">@DateTimeFormatHelper.FormatCardTime(session.StartTime, TimeZoneService)</span>
                        </div>
                        <div class="session-stats">
                            <span>+@(session.EnergyAddedKwh?.ToString("0.0") ?? "—") kWh</span>
                            <span class="session-stat-separator">·</span>
                            <span>@session.StartBatteryLevel.ToString("0")% → @(session.EndBatteryLevel?.ToString("0") ?? "—")%</span>
                            <span class="session-stat-separator">·</span>
                            <span>@DateTimeFormatHelper.FormatDuration(session.StartTime, session.EndTime)</span>
                        </div>
                    </div>
                </a>
            }
        </div>
    }
    else
    {
        <div class="card-empty-state">
            <Icon Name="zap" Size="48" Style="color: var(--color-text-muted); opacity: 0.5;" />
            <p>No charging sessions recorded yet</p>
        </div>
    }
</CardWrapper>

@code {
    [Parameter]
    public DashboardContext? Context { get; set; }

    private List<ChargingSession>? RecentSessions => Context?.RecentSessions;
    private Guid? VehiclePublicId => Context?.VehiclePublicId;
    private TimeZoneService? TimeZoneService => Context?.TimeZoneService;

    private static readonly DashboardCardDefinition _definition = new()
    {
        CardId = "charging",
        Icon = "zap",
        Title = "Recent Charging",
        DetailUrl = "/charging",
        DetailLabel = "View All"
    };

    private DashboardCardDefinition GetDefinition() => _definition with
    {
        DetailUrl = VehiclePublicId.HasValue ? $"/charging/{VehiclePublicId}" : _definition.DetailUrl
    };

    private string GetSessionUrl(int sessionId)
    {
        var baseUrl = VehiclePublicId.HasValue ? $"/charging/{VehiclePublicId}" : "/charging";
        return $"{baseUrl}?selected={sessionId}";
    }

}
