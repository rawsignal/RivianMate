@using RivianMate.Api.Components.Shared
@using RivianMate.Api.Helpers
@using RivianMate.Api.Services
@using RivianMate.Core.Entities

<CardWrapper Definition="@GetDefinition()">
    @if (RecentActivity?.Any() == true)
    {
        <div class="activity-list">
            @foreach (var activity in RecentActivity.Take(3))
            {
                <a href="@GetActivityUrl(activity.Id)" class="activity-item clickable">
                    <div class="activity-icon @ActivityTypeHelper.GetCssClass(activity.Type)">
                        <Icon Name="@ActivityTypeHelper.GetIcon(activity.Type)" Size="14" />
                    </div>
                    <div class="activity-details">
                        <span class="activity-message">@activity.Message</span>
                        <span class="activity-time">@DateTimeFormatHelper.FormatRelativeTime(activity.Timestamp, TimeZoneService)</span>
                    </div>
                </a>
            }
        </div>
    }
    else
    {
        <div class="card-empty-state">
            <Icon Name="list" Size="48" Style="color: var(--color-text-muted); opacity: 0.5;" />
            <p>No activity recorded yet</p>
        </div>
    }
</CardWrapper>

@code {
    [Parameter]
    public DashboardContext? Context { get; set; }

    private List<ActivityFeedItem>? RecentActivity => Context?.RecentActivity;
    private Guid? VehiclePublicId => Context?.VehiclePublicId;
    private TimeZoneService? TimeZoneService => Context?.TimeZoneService;

    private static readonly DashboardCardDefinition _definition = new()
    {
        CardId = "activity-feed",
        Icon = "list",
        Title = "Activity Feed",
        DetailUrl = "/activity",
        DetailLabel = "View All"
    };

    private DashboardCardDefinition GetDefinition() => _definition with
    {
        DetailUrl = VehiclePublicId.HasValue ? $"/activity/{VehiclePublicId}" : _definition.DetailUrl
    };

    private string GetActivityUrl(int activityId)
    {
        var baseUrl = VehiclePublicId.HasValue ? $"/activity/{VehiclePublicId}" : "/activity";
        return $"{baseUrl}?selected={activityId}";
    }

}
