@using RivianMate.Api.Components.Shared
@using RivianMate.Api.Services
@using RivianMate.Core.Entities
@using RivianMate.Core.Enums

<CardWrapper Definition="_definition">
    @if (VehicleState?.RangeEstimate != null)
    {
        <div class="quick-stat">
            <div class="quick-stat-value">
                @FormatRangeValue()<span class="quick-stat-unit">@GetDistanceUnit()</span>
            </div>
            @if (!string.IsNullOrEmpty(VehicleState.DriveMode))
            {
                <p class="quick-stat-subtext">
                    @FormatDriveMode(VehicleState.DriveMode)
                </p>
            }
        </div>
    }
    else
    {
        <div class="quick-stat">
            <div class="quick-stat-value muted">—</div>
        </div>
    }
</CardWrapper>

@code {
    [Parameter]
    public DashboardContext? Context { get; set; }

    private VehicleState? VehicleState => Context?.VehicleState;
    private UnitConversionService? UnitService => Context?.UnitConversionService;
    private DistanceUnit DistUnit => Context?.UserPreferences?.DistanceUnit ?? DistanceUnit.Miles;

    private static readonly DashboardCardDefinition _definition = new()
    {
        CardId = "range",
        Icon = "map-pin",
        Title = "Estimated Range"
    };

    private string FormatRangeValue()
    {
        if (VehicleState?.RangeEstimate == null) return "—";
        var converted = UnitService?.ConvertRange(VehicleState.RangeEstimate, DistUnit);
        return converted?.ToString("0") ?? "—";
    }

    private string GetDistanceUnit()
    {
        return UnitService?.GetDistanceUnit(DistUnit) ?? "mi";
    }

    private static string FormatDriveMode(string? mode) => mode switch
    {
        "everyday" => "All-Purpose Mode",
        "sport" => "Sport Mode",
        "conserve" => "Conserve Mode",
        "off_road_auto" => "Off-Road Auto",
        "off_road_rock" => "Rock Crawl Mode",
        "off_road_rally" => "Rally Mode",
        "off_road_drift" => "Drift Mode",
        "off_road_sand" => "Sand Mode",
        "towing" => "Towing Mode",
        "winter" => "Snow Mode",
        _ => mode?.Replace("_", " ") ?? ""
    };
}
