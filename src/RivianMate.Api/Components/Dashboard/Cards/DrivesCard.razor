@using RivianMate.Api.Components.Shared
@using RivianMate.Api.Services
@using RivianMate.Core.Entities
@using RivianMate.Core.Enums

<CardWrapper Definition="@GetDefinition()">
    @if (RecentDrives?.Any() == true)
    {
        <div class="drives-list">
            @foreach (var drive in RecentDrives.Take(4))
            {
                <div class="drive-item">
                    <div class="drive-icon">
                        <Icon Name="navigation" Size="16" />
                    </div>
                    <div class="drive-details">
                        <div class="drive-header">
                            <span class="drive-distance">@FormatDistance(drive.DistanceMiles)</span>
                            <span class="drive-time">@FormatDriveTime(drive.StartTime)</span>
                        </div>
                        @if (!string.IsNullOrEmpty(drive.StartAddress) || !string.IsNullOrEmpty(drive.EndAddress))
                        {
                            <div class="drive-route-vertical">
                                <div class="drive-route-point">
                                    <span class="drive-route-dot start"></span>
                                    <span class="drive-route-addr">@(drive.StartAddress ?? "Unknown")</span>
                                </div>
                                <div class="drive-route-point">
                                    <span class="drive-route-dot end"></span>
                                    <span class="drive-route-addr">@(drive.EndAddress ?? "Unknown")</span>
                                </div>
                            </div>
                        }
                        <div class="drive-stats">
                            <span>@FormatEfficiency(drive.EfficiencyMilesPerKwh)</span>
                            <span class="drive-stat-separator">·</span>
                            <span>@FormatDuration(drive.StartTime, drive.EndTime)</span>
                            @if (drive.AverageSpeedMph.HasValue)
                            {
                                <span class="drive-stat-separator">·</span>
                                <span>@FormatSpeed(drive.AverageSpeedMph.Value) avg</span>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="card-empty-state">
            <Icon Name="navigation" Size="48" Style="color: var(--color-text-muted); opacity: 0.5;" />
            <p>No drives recorded yet</p>
        </div>
    }
</CardWrapper>

@code {
    [Parameter]
    public DashboardContext? Context { get; set; }

    private List<Drive>? RecentDrives => Context?.RecentDrives;
    private Guid? VehiclePublicId => Context?.VehiclePublicId;
    private TimeZoneService? TimeZoneService => Context?.TimeZoneService;
    private UnitConversionService? UnitService => Context?.UnitConversionService;
    private DistanceUnit DistUnit => Context?.UserPreferences?.DistanceUnit ?? DistanceUnit.Miles;

    private static readonly DashboardCardDefinition _definition = new()
    {
        CardId = "drives",
        Icon = "navigation",
        Title = "Recent Drives",
        DetailUrl = "/drives",
        DetailLabel = "View All"
    };

    private DashboardCardDefinition GetDefinition() => _definition with
    {
        DetailUrl = VehiclePublicId.HasValue ? $"/drives/{VehiclePublicId}" : _definition.DetailUrl
    };

    private string FormatDistance(double? miles)
    {
        if (miles == null) return "—";
        var converted = UnitService?.ConvertDistance(miles, DistUnit);
        var unit = UnitService?.GetDistanceUnit(DistUnit) ?? "mi";
        return $"{converted?.ToString("0.0") ?? "—"} {unit}";
    }

    private string FormatEfficiency(double? efficiency)
    {
        if (efficiency == null) return "—";
        var converted = UnitService?.ConvertEfficiency(efficiency, DistUnit);
        var unit = UnitService?.GetEfficiencyUnit(DistUnit) ?? "mi/kWh";
        return $"{converted?.ToString("0.0") ?? "—"} {unit}";
    }

    private string FormatSpeed(double mph)
    {
        // AverageSpeedMph is stored as mph, convert to m/s first then use service
        var metersPerSecond = mph / 2.23694;
        var converted = UnitService?.ConvertSpeed(metersPerSecond, DistUnit);
        var unit = UnitService?.GetSpeedUnit(DistUnit) ?? "mph";
        return $"{converted?.ToString("0") ?? mph.ToString("0")} {unit}";
    }

    private string FormatDriveTime(DateTime utcTime)
    {
        if (TimeZoneService == null)
            return utcTime.ToString("MMM d, h:mm tt");

        var localTime = TimeZoneService.ToLocalTime(utcTime);
        var today = TimeZoneService.ToLocalTime(DateTime.UtcNow).Date;
        if (localTime.Date == today) return $"Today, {localTime:h:mm tt}";
        if (localTime.Date == today.AddDays(-1)) return $"Yesterday, {localTime:h:mm tt}";
        return localTime.ToString("MMM d, h:mm tt");
    }

    private static string FormatDuration(DateTime start, DateTime? end)
    {
        if (end == null) return "In progress";
        var duration = end.Value - start;
        if (duration.TotalMinutes < 60) return $"{(int)duration.TotalMinutes} min";
        return $"{(int)duration.TotalHours}h {duration.Minutes}m";
    }
}
