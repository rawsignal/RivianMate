@using RivianMate.Api.Components.Shared
@using RivianMate.Api.Services
@using RivianMate.Core.Entities
@using RivianMate.Core.Enums

@if (Compact)
{
    <div class="bottom-stat-card">
        <div class="bottom-stat-label">
            <Icon Name="@_definition.Icon" Size="14" />
            @_definition.Title
        </div>
        <p class="bottom-stat-value">
            @FormatTemperatureValue()
            @if (VehicleState?.CabinTemperature != null)
            {
                <span class="bottom-stat-unit">@GetTemperatureUnit()</span>
            }
        </p>
    </div>
}
else
{
    <CardWrapper Definition="_definition">
        <div class="quick-stat">
            @if (VehicleState?.CabinTemperature != null)
            {
                <div class="quick-stat-value">
                    @FormatTemperatureValue()<span class="quick-stat-unit">@GetTemperatureUnit()</span>
                </div>
            }
            else
            {
                <div class="quick-stat-value muted">—</div>
            }
        </div>
    </CardWrapper>
}

@code {
    [Parameter]
    public DashboardContext? Context { get; set; }

    private VehicleState? VehicleState => Context?.VehicleState;
    private bool Compact => Context?.IsCompact ?? false;
    private UnitConversionService? UnitService => Context?.UnitConversionService;
    private TemperatureUnit TempUnit => Context?.UserPreferences?.TemperatureUnit ?? TemperatureUnit.Fahrenheit;

    private static readonly DashboardCardDefinition _definition = new()
    {
        CardId = "cabin-temp",
        Icon = "thermometer",
        Title = "Cabin Temp"
    };

    private string FormatTemperatureValue()
    {
        if (VehicleState?.CabinTemperature == null) return "—";
        var converted = UnitService?.ConvertTemperature(VehicleState.CabinTemperature, TempUnit);
        return converted?.ToString("0") ?? "—";
    }

    private string GetTemperatureUnit()
    {
        return UnitService?.GetTemperatureUnit(TempUnit) ?? "°F";
    }
}
