@page "/charging"
@page "/charging/{VehicleId:guid}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using RivianMate.Api.Components.Shared
@using RivianMate.Core.Entities
@using RivianMate.Core.Enums
@using RivianMate.Api.Helpers
@attribute [Authorize]
@inject VehicleService VehicleService
@inject TimeZoneService TimeZoneService
@inject UserPreferencesService UserPreferencesService
@inject UnitConversionService UnitConversionService
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@inject ILogger<Charging> Logger
@inject VehicleSelectionService VehicleSelectionService
@implements IAsyncDisposable

<PageTitle>Charging - RivianMate</PageTitle>

<!-- Page Header -->
<div style="margin-bottom: var(--space-8);">
    <a href="/" style="font-size: 0.875rem; color: var(--color-text-muted); display: inline-flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-4);">
        <Icon Name="chevron-left" Size="16" />
        Back to Dashboard
    </a>
    <h1 style="display: flex; align-items: center; gap: var(--space-3);">
        <Icon Name="zap" Size="28" Style="color: var(--color-accent);" />
        Charging History
    </h1>
</div>

@if (_loading)
{
    <div class="loading">
        <p>Loading charging sessions...</p>
    </div>
}
else if (_notFound)
{
    <NotFound Title="Vehicle Not Found"
              Message="The requested vehicle was not found or you don't have access to it."
              Icon="zap" />
}
else if (_noVehicles)
{
    <div class="card" style="text-align: center; padding: var(--space-12);">
        <Icon Name="car" Size="64" Style="color: var(--color-text-muted); opacity: 0.3; margin-bottom: var(--space-4);" />
        <h3 style="margin-bottom: var(--space-4);">No Vehicles Found</h3>
        <p style="margin-bottom: var(--space-4);">Link a Rivian account to start tracking your charging sessions.</p>
        <a href="/settings" class="btn btn-primary">Go to Settings</a>
    </div>
}
else if (_sessions == null || !_sessions.Any())
{
    <div class="card" style="text-align: center; padding: var(--space-12);">
        <Icon Name="zap" Size="64" Style="color: var(--color-text-muted); opacity: 0.3; margin-bottom: var(--space-4);" />
        <h3 style="margin-bottom: var(--space-4);">No Charging Sessions Recorded</h3>
        <p>Charging data will appear here once RivianMate detects your vehicle charging.</p>
        <p style="margin-top: var(--space-2); color: var(--color-text-muted);">Sessions are automatically tracked when your vehicle is plugged in.</p>
    </div>
}
else
{
    <!-- Summary Stats -->
    <div class="card mb-6">
        <div class="grid-5">
            <div class="mini-stat">
                <p class="mini-stat-label">Total Sessions</p>
                <p class="mini-stat-value">@_totalSessions</p>
            </div>
            <div class="mini-stat">
                <p class="mini-stat-label">Total Energy</p>
                <p class="mini-stat-value">@_totalEnergy.ToString("N0") <span class="mini-stat-unit">kWh</span></p>
            </div>
            <div class="mini-stat">
                <p class="mini-stat-label">Total Cost</p>
                <p class="mini-stat-value">@FormatCost(_totalCost)</p>
            </div>
            <div class="mini-stat">
                <p class="mini-stat-label">Home Charges</p>
                <p class="mini-stat-value">@_homeCharges</p>
            </div>
            <div class="mini-stat">
                <p class="mini-stat-label">DC Fast Charges</p>
                <p class="mini-stat-value">@_dcfcCharges</p>
            </div>
        </div>
    </div>

    <div class="grid-2">
        <!-- Charging Sessions List -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <Icon Name="list" Size="20" Style="color: var(--color-accent);" />
                    All Sessions
                </h2>
            </div>

            <div class="charging-list-full">
                @foreach (var session in _sessions)
                {
                    <div class="charging-list-item @(_selectedSession?.Id == session.Id ? "selected" : "")" @onclick="() => SelectSession(session)">
                        <div class="charging-list-icon @ChargeTypeHelper.GetCssClass(session.ChargeType)">
                            <Icon Name="@ChargeTypeHelper.GetIcon(session.ChargeType)" Size="18" />
                        </div>
                        <div class="charging-list-content">
                            <div class="charging-list-header">
                                <span class="charging-list-energy">+@(session.EnergyAddedKwh?.ToString("0.0") ?? "—") kWh</span>
                                <span class="charging-list-date">@DateTimeFormatHelper.FormatRelativeDate(session.StartTime, TimeZoneService)</span>
                            </div>
                            <div class="charging-list-meta">
                                <span>@GetSessionLocationDisplay(session)</span>
                                <span>·</span>
                                <span>@session.StartBatteryLevel.ToString("0")% → @(session.EndBatteryLevel?.ToString("0") ?? "—")%</span>
                            </div>
                        </div>
                        <div class="charging-list-chevron">
                            <Icon Name="chevron-right" Size="16" />
                        </div>
                    </div>
                }
            </div>

            <Pagination CurrentPage="_currentPage"
                        PageSize="_pageSize"
                        TotalCount="_totalCount"
                        OnPageChanged="GoToPage" />
        </div>

        <!-- Session Details -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <Icon Name="info" Size="20" Style="color: var(--color-accent);" />
                    Session Details
                </h2>
            </div>

            @if (_selectedSession == null)
            {
                <div class="session-details-empty">
                    <Icon Name="mouse-pointer" Size="48" Style="color: var(--color-text-muted); opacity: 0.3;" />
                    <p>Select a session to view details</p>
                </div>
            }
            else
            {
                <div class="session-details">
                    <!-- Location -->
                    <div class="session-detail-section">
                        <h4>
                            <Icon Name="map-pin" Size="16" />
                            Location
                        </h4>
                        <div class="session-detail-grid">
                            <div class="session-detail-item">
                                <span class="session-detail-label">Location</span>
                                <span class="session-detail-value">@(_selectedSession.LocationName ?? "Unknown")</span>
                            </div>
                            <div class="session-detail-item">
                                <span class="session-detail-label">Type</span>
                                <span class="session-detail-value">
                                    @if (_selectedSession.IsHomeCharging == true)
                                    {
                                        <span class="badge badge-home">Home</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-@ChargeTypeHelper.GetCssClass(_selectedSession.ChargeType)">@ChargeTypeHelper.GetDisplayName(_selectedSession.ChargeType)</span>
                                    }
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Time -->
                    <div class="session-detail-section">
                        <h4>
                            <Icon Name="clock" Size="16" />
                            Time
                        </h4>
                        <div class="session-detail-grid">
                            <div class="session-detail-item">
                                <span class="session-detail-label">Started</span>
                                <span class="session-detail-value">@DateTimeFormatHelper.FormatDateTime(_selectedSession.StartTime, TimeZoneService)</span>
                            </div>
                            <div class="session-detail-item">
                                <span class="session-detail-label">Ended</span>
                                <span class="session-detail-value">@(_selectedSession.EndTime.HasValue ? DateTimeFormatHelper.FormatDateTime(_selectedSession.EndTime.Value, TimeZoneService) : "In Progress")</span>
                            </div>
                            <div class="session-detail-item">
                                <span class="session-detail-label">Duration</span>
                                <span class="session-detail-value">@DateTimeFormatHelper.FormatDuration(_selectedSession.StartTime, _selectedSession.EndTime)</span>
                            </div>
                        </div>
                    </div>

                    <!-- Energy & Power -->
                    <div class="session-detail-section">
                        <h4>
                            <Icon Name="zap" Size="16" />
                            Energy & Power
                        </h4>
                        <div class="session-detail-grid">
                            <div class="session-detail-item">
                                <span class="session-detail-label">Energy Added</span>
                                <span class="session-detail-value">@(_selectedSession.EnergyAddedKwh?.ToString("0.0") ?? "—") kWh</span>
                            </div>
                            <div class="session-detail-item">
                                <span class="session-detail-label">Peak Power</span>
                                <span class="session-detail-value">@(_selectedSession.PeakPowerKw?.ToString("0") ?? "—") kW</span>
                            </div>
                            <div class="session-detail-item">
                                <span class="session-detail-label">Average Power</span>
                                <span class="session-detail-value">@(_selectedSession.AveragePowerKw?.ToString("0.0") ?? "—") kW</span>
                            </div>
                        </div>
                    </div>

                    <!-- Cost -->
                    @{
                        var sessionCost = GetSessionCost(_selectedSession);
                        var isEstimated = IsEstimatedCost(_selectedSession);
                    }
                    @if (sessionCost.HasValue || _selectedSession.IsHomeCharging == true)
                    {
                        <div class="session-detail-section">
                            <h4>
                                <Icon Name="dollar-sign" Size="16" />
                                Cost@(isEstimated ? " (Estimated)" : "")
                            </h4>
                            <div class="session-detail-grid">
                                <div class="session-detail-item">
                                    <span class="session-detail-label">@(isEstimated ? "Est. Cost" : "Cost")</span>
                                    <span class="session-detail-value session-cost">@FormatCost(sessionCost)</span>
                                </div>
                            </div>
                            @if (isEstimated)
                            {
                                <p style="margin-top: var(--space-2); font-size: 0.7rem; color: var(--color-text-muted);">
                                    Estimated from your location rate. Configure in Settings → Charging Locations.
                                </p>
                            }
                        </div>
                    }
                    else if (_selectedSession.ChargeType == ChargeType.DC_Fast)
                    {
                        <div class="session-detail-section">
                            <h4>
                                <Icon Name="dollar-sign" Size="16" />
                                Cost
                            </h4>
                            <p style="font-size: 0.875rem; color: var(--color-text-muted);">
                                Cost data not available from charging network.
                            </p>
                        </div>
                    }

                    <!-- Battery -->
                    <div class="session-detail-section">
                        <h4>
                            <Icon Name="battery" Size="16" />
                            Battery
                        </h4>
                        <div class="session-detail-grid">
                            <div class="session-detail-item">
                                <span class="session-detail-label">Start Level</span>
                                <span class="session-detail-value">@_selectedSession.StartBatteryLevel.ToString("0")%</span>
                            </div>
                            <div class="session-detail-item">
                                <span class="session-detail-label">End Level</span>
                                <span class="session-detail-value">@(_selectedSession.EndBatteryLevel?.ToString("0") ?? "—")%</span>
                            </div>
                            <div class="session-detail-item">
                                <span class="session-detail-label">Charge Limit</span>
                                <span class="session-detail-value">@(_selectedSession.ChargeLimit?.ToString("0") ?? "—")%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Range -->
                    @if (_selectedSession.RangeAdded.HasValue || _selectedSession.StartRangeEstimate.HasValue)
                    {
                        <div class="session-detail-section">
                            <h4>
                                <Icon Name="map" Size="16" />
                                Range
                            </h4>
                            <div class="session-detail-grid">
                                @if (_selectedSession.StartRangeEstimate.HasValue)
                                {
                                    <div class="session-detail-item">
                                        <span class="session-detail-label">Start Range</span>
                                        <span class="session-detail-value">@FormatRange(_selectedSession.StartRangeEstimate)</span>
                                    </div>
                                }
                                @if (_selectedSession.EndRangeEstimate.HasValue)
                                {
                                    <div class="session-detail-item">
                                        <span class="session-detail-label">End Range</span>
                                        <span class="session-detail-value">@FormatRange(_selectedSession.EndRangeEstimate)</span>
                                    </div>
                                }
                                @if (_selectedSession.RangeAdded.HasValue)
                                {
                                    <div class="session-detail-item">
                                        <span class="session-detail-label">Range Added</span>
                                        <span class="session-detail-value">+@FormatRange(_selectedSession.RangeAdded)</span>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- Map -->
                    <div class="session-detail-section">
                        <h4>
                            <Icon Name="map-pin" Size="16" />
                            Charge Location
                        </h4>
                        @if (_selectedSession.Latitude.HasValue && _selectedSession.Longitude.HasValue)
                        {
                            <div id="charge-map" class="charge-map-container"></div>
                        }
                        else
                        {
                            <div class="charge-map-empty">
                                <Icon Name="map-pin" Size="32" Style="color: var(--color-text-muted); opacity: 0.3;" />
                                <p>No location data available</p>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
}

@code {
    [Parameter]
    public Guid? VehicleId { get; set; }

    [SupplyParameterFromQuery(Name = "selected")]
    public int? SelectedSessionId { get; set; }

    private List<ChargingSession>? _sessions;
    private ChargingSession? _selectedSession;
    private bool _loading = true;
    private bool _notFound;
    private bool _noVehicles;
    private bool _mapInitialized;
    private bool _pendingMapUpdate;
    private double _totalEnergy;
    private int _homeCharges;
    private int _dcfcCharges;
    private double _totalCost;
    private int _totalSessions;
    private Guid _userId;
    private int? _internalVehicleId;

    // Pagination
    private int _pageSize = 10;
    private int _currentPage = 1;
    private int _totalCount = 0;

    // User preferences for unit display and home charging rate
    private UserPreferences? _userPreferences;
    private double _homeElectricityRate = 0.15; // $/kWh default
    private string _currencyCode = "USD";
    private DistanceUnit _distanceUnit = DistanceUnit.Miles;

    protected override async Task OnInitializedAsync()
    {
        TimeZoneService.OnTimeZoneChanged += OnTimeZoneChanged;
        await LoadDataAsync();
    }

    private void OnTimeZoneChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Initialize timezone from localStorage
            var previousTz = TimeZoneService.TimeZoneId;
            await TimeZoneService.InitializeAsync();
            if (previousTz != TimeZoneService.TimeZoneId)
            {
                StateHasChanged();
            }
        }

        if (_pendingMapUpdate && _selectedSession?.Latitude != null && _selectedSession?.Longitude != null)
        {
            _pendingMapUpdate = false;

            try
            {
                if (!_mapInitialized)
                {
                    await JS.InvokeVoidAsync("chargeMap.initialize", "charge-map");
                    _mapInitialized = true;
                }

                await JS.InvokeVoidAsync("chargeMap.setMarker",
                    _selectedSession.Latitude.Value,
                    _selectedSession.Longitude.Value,
                    _selectedSession.LocationName ?? ChargeTypeHelper.GetDisplayName(_selectedSession.ChargeType),
                    ChargeTypeHelper.GetCssClass(_selectedSession.ChargeType));
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error initializing or updating charge map");
            }
        }
    }

    private async Task LoadDataAsync()
    {
        _loading = true;

        try
        {
            _userId = await VehicleSelectionService.GetUserIdAsync(AuthStateProvider);
            if (_userId == Guid.Empty) return;

            // Load user preferences for home electricity rate and currency
            _userPreferences = await UserPreferencesService.GetPreferencesAsync(_userId);
            _homeElectricityRate = _userPreferences?.HomeElectricityRate ?? 0.15;
            _currencyCode = _userPreferences?.CurrencyCode ?? "USD";
            _distanceUnit = _userPreferences?.DistanceUnit ?? DistanceUnit.Miles;

            var selection = await VehicleSelectionService.ResolveVehicleAsync(_userId, VehicleId, JS);
            if (selection.NoVehicles) { _noVehicles = true; return; }
            if (selection.NotFound) { _notFound = true; return; }
            var vehicle = selection.Vehicle;

            if (vehicle != null)
            {
                _internalVehicleId = vehicle.Id;

                // Load aggregate summary stats (computed in DB, no full data load)
                var stats = await VehicleService.GetChargingSummaryStatsAsync(vehicle.Id, _homeElectricityRate);
                _totalSessions = stats.TotalSessions;
                _totalEnergy = stats.TotalEnergyKwh;
                _homeCharges = stats.HomeCharges;
                _dcfcCharges = stats.DcfcCharges;
                _totalCost = stats.TotalCost;

                // Load paginated sessions for display
                var (sessions, totalCount) = await VehicleService.GetChargingSessionsPagedAsync(
                    vehicle.Id, _currentPage, _pageSize);
                _sessions = sessions;
                _totalCount = totalCount;

                if (_sessions?.Any() == true)
                {
                    // If a specific session was requested via query param, try to select it
                    if (SelectedSessionId.HasValue)
                    {
                        var requestedSession = _sessions.FirstOrDefault(s => s.Id == SelectedSessionId.Value);
                        if (requestedSession != null)
                        {
                            await SelectSessionAsync(requestedSession);
                        }
                        else
                        {
                            // Session not on current page, try to load it directly
                            var session = await VehicleService.GetChargingSessionByIdAsync(vehicle.Id, SelectedSessionId.Value);
                            if (session != null)
                            {
                                await SelectSessionAsync(session);
                            }
                            else if (_sessions.FirstOrDefault() is { } firstSession)
                            {
                                await SelectSessionAsync(firstSession);
                            }
                        }
                    }
                    else if (_sessions.FirstOrDefault() is { } firstSession)
                    {
                        await SelectSessionAsync(firstSession);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading charging sessions");
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task SelectSessionAsync(ChargingSession session)
    {
        _selectedSession = session;

        if (session.Latitude.HasValue && session.Longitude.HasValue)
        {
            _pendingMapUpdate = true;
        }

        StateHasChanged();
        await Task.CompletedTask;
    }

    private void SelectSession(ChargingSession session)
    {
        _ = SelectSessionAsync(session);
    }

    private async Task GoToPage(int page)
    {
        if (_internalVehicleId == null) return;

        _currentPage = page;
        var (sessions, _) = await VehicleService.GetChargingSessionsPagedAsync(
            _internalVehicleId.Value, _currentPage, _pageSize);
        _sessions = sessions;

        // Select first session on the new page
        if (_sessions?.Any() == true)
        {
            await SelectSessionAsync(_sessions.First());
        }
        else
        {
            _selectedSession = null;
        }
    }

    /// <summary>
    /// Get the display text for a session's location.
    /// Shows location name if available, "Home" if marked as home charging, or charge type.
    /// </summary>
    private static string GetSessionLocationDisplay(ChargingSession session)
    {
        // If we have a location name, use it
        if (!string.IsNullOrEmpty(session.LocationName))
            return session.LocationName;

        // If marked as home charging (even without location name), show "Home"
        if (session.IsHomeCharging == true)
            return "Home";

        // Fall back to charge type
        return ChargeTypeHelper.GetDisplayName(session.ChargeType);
    }

    /// <summary>
    /// Get the cost for a charging session.
    /// Uses stored cost (from API or location-based estimate) if available,
    /// falls back to legacy home electricity rate for old sessions.
    /// </summary>
    private double? GetSessionCost(ChargingSession session)
    {
        // Cost stored on session (from API or location-based estimate)
        if (session.Cost.HasValue)
            return session.Cost.Value;

        // Fallback: old sessions with IsHomeCharging but no Cost (pre-migration)
        if (session.IsHomeCharging == true && session.EnergyAddedKwh > 0 && _homeElectricityRate > 0)
        {
            return session.EnergyAddedKwh.Value * _homeElectricityRate;
        }

        return null;
    }

    /// <summary>
    /// Check if the cost is estimated (from location rate) rather than API-provided.
    /// </summary>
    private bool IsEstimatedCost(ChargingSession session)
    {
        // If session has a linked user location, cost is estimated from location rate
        if (session.UserLocationId != null && session.Cost.HasValue)
            return true;
        // Legacy fallback
        return !session.Cost.HasValue && session.IsHomeCharging == true;
    }

    private string FormatCost(double? cost)
    {
        if (!cost.HasValue || cost < 0.01) return "—";
        return UnitConversionService.FormatCurrency(cost, _currencyCode);
    }

    private string FormatRange(double? miles)
    {
        if (!miles.HasValue) return "—";
        return UnitConversionService.FormatRange(miles, _distanceUnit);
    }

    public async ValueTask DisposeAsync()
    {
        TimeZoneService.OnTimeZoneChanged -= OnTimeZoneChanged;

        if (_mapInitialized)
        {
            try
            {
                await JS.InvokeVoidAsync("chargeMap.dispose");
            }
            catch
            {
                // Ignore errors during disposal
            }
        }
    }
}
