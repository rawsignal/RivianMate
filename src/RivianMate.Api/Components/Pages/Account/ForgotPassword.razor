@page "/forgot-password"
@layout RivianMate.Api.Components.Layout.PublicLayout
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using Microsoft.Extensions.Options
@using RivianMate.Core.Entities
@using RivianMate.Api.Configuration
@using RivianMate.Api.Services.Email

@inject UserManager<ApplicationUser> UserManager
@inject IEmailTrigger EmailTrigger
@inject IOptions<EmailConfiguration> EmailConfig
@inject NavigationManager NavigationManager
@inject ILogger<ForgotPassword> Logger

<PageTitle>Forgot Password - RivianMate</PageTitle>

<div class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <div class="logo-icon"></div>
            <h1>Reset Password</h1>
            <p>Enter your email and we'll send you a reset link</p>
        </div>

        @if (submitted)
        {
            <div class="alert alert-success">
                <strong>Check your email</strong><br />
                If an account exists with that email address, we've sent password reset instructions.
            </div>
            <div class="auth-footer">
                <p><a href="/login">Back to Sign In</a></p>
            </div>
        }
        else
        {
            @if (!EmailConfig.Value.Enabled)
            {
                <div class="alert alert-warning">
                    Email is not configured. Please contact your administrator to reset your password.
                </div>
                <div class="auth-footer">
                    <p><a href="/login">Back to Sign In</a></p>
                </div>
            }
            else
            {
                <EditForm Model="Input" method="post" OnValidSubmit="OnSubmit" FormName="forgot-password">
                    <DataAnnotationsValidator />

                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <InputText @bind-Value="Input.Email" id="email" type="email" placeholder="you@example.com" autocomplete="email" />
                        <ValidationMessage For="() => Input.Email" class="validation-message" />
                    </div>

                    <button type="submit" class="btn btn-primary btn-full">Send Reset Link</button>
                </EditForm>

                <div class="auth-footer">
                    <p>Remember your password? <a href="/login">Sign In</a></p>
                </div>
            }
        }

        <div class="auth-copyright">
            <p>&copy; @DateTime.Now.Year Rossignol Software Services, LLC</p>
        </div>
    </div>
</div>

@code {
    private bool submitted;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    private async Task OnSubmit()
    {
        var user = await UserManager.FindByEmailAsync(Input.Email);

        if (user != null)
        {
            // Generate password reset token
            var token = await UserManager.GeneratePasswordResetTokenAsync(user);
            var encodedToken = Uri.EscapeDataString(token);
            var encodedEmail = Uri.EscapeDataString(Input.Email);

            // Build reset link
            var baseUrl = EmailConfig.Value.BaseUrl.TrimEnd('/');
            var resetLink = $"{baseUrl}/reset-password?email={encodedEmail}&token={encodedToken}";

            // Fire the email
            EmailTrigger.FirePasswordReset(
                user.Email!,
                resetLink,
                user.DisplayName ?? user.Email
            );

            Logger.LogInformation("Password reset email queued for {Email}", Input.Email);
        }
        else
        {
            // Log but don't reveal that user doesn't exist
            Logger.LogInformation("Password reset requested for non-existent email: {Email}", Input.Email);
        }

        // Always show success to prevent email enumeration
        submitted = true;
    }

    private sealed class InputModel
    {
        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid email format")]
        public string Email { get; set; } = "";
    }
}
