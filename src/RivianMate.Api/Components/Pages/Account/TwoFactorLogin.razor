@page "/login-2fa"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using RivianMate.Api.Components.Shared
@using RivianMate.Api.Services
@using RivianMate.Core.Entities

@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject TwoFactorService TwoFactorService
@inject NavigationManager NavigationManager
@inject ILogger<TwoFactorLogin> Logger

<PageTitle>Two-Factor Authentication - RivianMate</PageTitle>

<div class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <div class="logo-icon"></div>
            <h1>Two-Factor Authentication</h1>
            <p>Enter the code from your authenticator app</p>
        </div>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="alert alert-error">
                @_errorMessage
            </div>
        }

        <EditForm Model="Input" method="post" OnValidSubmit="OnValidSubmitAsync" FormName="login-2fa">
            <DataAnnotationsValidator />

            <div class="form-group">
                <label for="code">Authentication Code</label>
                <InputText @bind-Value="Input.Code" id="code" type="text"
                           placeholder="000000" maxlength="6" autocomplete="one-time-code"
                           inputmode="numeric" pattern="[0-9]*" autofocus="true" />
                <ValidationMessage For="() => Input.Code" class="validation-message" />
            </div>

            <div class="form-group checkbox-group">
                <InputCheckbox @bind-Value="Input.RememberMachine" id="rememberMachine" />
                <label for="rememberMachine">Remember this device for 30 days</label>
            </div>

            <button type="submit" class="btn btn-primary btn-full">Verify</button>
        </EditForm>

        <div class="auth-footer" style="margin-top: var(--space-6);">
            <p>
                <a href="/login-2fa-recovery?returnUrl=@Uri.EscapeDataString(ReturnUrl ?? "/")&rememberMe=@RememberMe">
                    Use a recovery code instead
                </a>
            </p>
        </div>

        <div class="auth-copyright">
            <p>&copy; @DateTime.Now.Year Rossignol Software Services, LLC</p>
        </div>
    </div>
</div>

@code {
    private string? _errorMessage;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    [SupplyParameterFromQuery]
    private bool RememberMe { get; set; }

    private async Task OnValidSubmitAsync()
    {
        // Strip any spaces or dashes from the code
        var code = Input.Code.Replace(" ", "").Replace("-", "");

        var result = await SignInManager.TwoFactorAuthenticatorSignInAsync(
            code,
            RememberMe,
            Input.RememberMachine);

        if (result.Succeeded)
        {
            // Get the user to update last login time
            var user = await SignInManager.GetTwoFactorAuthenticationUserAsync();
            if (user != null)
            {
                user.LastLoginAt = DateTime.UtcNow;
                await UserManager.UpdateAsync(user);

                await TwoFactorService.LogSecurityEventAsync(user.Id, "TwoFactorLoginSuccess");
                Logger.LogInformation("User {UserId} logged in with 2FA.", user.Id);
            }

            NavigationManager.NavigateTo(ReturnUrl ?? "/", forceLoad: true);
        }
        else if (result.IsLockedOut)
        {
            Logger.LogWarning("User account locked out during 2FA.");
            _errorMessage = "Account locked. Please try again in 15 minutes.";
        }
        else
        {
            var user = await SignInManager.GetTwoFactorAuthenticationUserAsync();
            if (user != null)
            {
                await TwoFactorService.LogSecurityEventAsync(user.Id, "TwoFactorLoginFailed");
            }

            Logger.LogWarning("Invalid 2FA code entered.");
            _errorMessage = "Invalid authentication code.";
        }
    }

    private sealed class InputModel
    {
        [Required(ErrorMessage = "Authentication code is required")]
        [StringLength(6, MinimumLength = 6, ErrorMessage = "Code must be 6 digits")]
        [RegularExpression(@"^\d{6}$", ErrorMessage = "Code must be 6 digits")]
        public string Code { get; set; } = "";

        public bool RememberMachine { get; set; }
    }
}
