@using RivianMate.Api.Services
@using RivianMate.Core.Entities
@using RivianMate.Core.Enums

<StatusSection Title="Location" Icon="map-pin">
    @if (VehicleState?.Latitude != null && VehicleState?.Longitude != null)
    {
        <StatusItem Label="Coordinates" Value="@FormatCoordinates(VehicleState.Latitude, VehicleState.Longitude)" />
        @if (VehicleState.Altitude != null)
        {
            <StatusItem Label="Altitude" Value="@FormatAltitude(VehicleState.Altitude)" />
        }
        @if (VehicleState.Speed != null && VehicleState.Speed > 0)
        {
            <StatusItem Label="Speed" Value="@FormatSpeed(VehicleState.Speed)" />
        }
        @if (VehicleState.Heading != null)
        {
            <StatusItem Label="Heading" Value="@FormatHeading(VehicleState.Heading)" />
        }
    }
    else
    {
        <StatusItem Label="Location" Value="Not available" Muted="true" />
    }
</StatusSection>

@code {
    [Parameter] public VehicleState? VehicleState { get; set; }
    [Parameter] public UnitConversionService? UnitService { get; set; }
    [Parameter] public DistanceUnit DistanceUnit { get; set; } = DistanceUnit.Miles;

    private static string FormatCoordinates(double? lat, double? lng)
    {
        if (lat == null || lng == null) return "—";
        return $"{lat:0.0000}°, {lng:0.0000}°";
    }

    private string FormatAltitude(double? meters)
    {
        if (meters == null) return "—";
        if (DistanceUnit == DistanceUnit.Kilometers)
        {
            return $"{meters:0} m";
        }
        // Convert to feet for imperial
        var feet = meters.Value * 3.28084;
        return $"{feet:0} ft";
    }

    private string FormatSpeed(double? metersPerSecond)
    {
        if (metersPerSecond == null) return "—";
        return UnitService?.FormatSpeed(metersPerSecond, DistanceUnit) ?? $"{metersPerSecond:0} m/s";
    }

    private static string FormatHeading(double? degrees)
    {
        if (degrees == null) return "—";
        var direction = degrees.Value switch
        {
            >= 337.5 or < 22.5 => "N",
            >= 22.5 and < 67.5 => "NE",
            >= 67.5 and < 112.5 => "E",
            >= 112.5 and < 157.5 => "SE",
            >= 157.5 and < 202.5 => "S",
            >= 202.5 and < 247.5 => "SW",
            >= 247.5 and < 292.5 => "W",
            _ => "NW"
        };
        return $"{degrees:0}° ({direction})";
    }
}
